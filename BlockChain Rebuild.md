BlockChain rebuild 重构区块链

[TOC]

# 前言
撰写这篇手册，并不简单的因为区块链是一个热门话题，更因为随着研究的深入，你会发现这是一个相当复杂的领域。关于这一话题的信息来源无外乎三个方面：技术文档和代码，商业机构的宣传，研究机构或个人的整理。但是每一种媒体都因其形式、渠道或作者而带有某种偏见。技术文档固然详细精确，但是不够通俗，视野也不够广阔；商业宣传必定带有一定的偏向性；而看似中立的研究机构和媒体也因其背后资助方或者受众市场的差异而显现出意识形态的不同。区块链领域的技术人员喜欢强调其技术领先性，但偏偏这一领域在学术界还没有一致的评判标准。区块链商业机构流行的白皮书，只有极少数既保留了技术细节，又蕴含对整个体系的理解。媒体和研究机构里则存在一种悖论，那些对区块链理解不够深，但是想象力丰富的人，率先推出了所谓的畅销书，只能让普通人初步理解一些浅层的知识，无法用来灵活运用和价值创造。只有那些深入区块链一线的研究员才会意识到，这个领域还处在高速变化期，很多东西都没有定性，出书立著为时尚早。

笔者不是最早的区块链研究员，该手册的内容是从2017年中期的研习笔记开始，逐渐积累而来。当时大家对比特币的看法还在交易代币和价值储存间徘徊，手册第二章节会重点探讨这个问题。而近年来对于区块链技术的探索，也从基本的交易协议扩展，到共识机制扩展，和算力的扩展。这就好像同时站在了密码学，社会学，计算机科学的交叉口。这让笔者联想到6年前和时任天猫总裁的[张勇](https://baike.baidu.com/item/张勇/3126436)（逍遥子）对话时，他提到全中国真正理解“电子商务”的人可能只有10个，因为“电子商务”里包含了“电子”这个不断变化的元素，也包含了“商务”这个需要稳定，需要持久的元素。一年后张勇升任阿里集团首席运营官，如今已是集团CEO。要说到区块链蕴含的元素，一个是相对稳定的技术，一个是非常不稳定的人性。但深层次上，这两者是统一的，手册最后章节会在这里展开。也正是这种不稳定，使本文所述不敢妄称为书。要说和本册子的内容形式最像的，应该就属北大经济学教授[汪丁丁](https://baike.baidu.com/item/汪丁丁)的《经济学思想史讲义》。他不是讲具体的经济学，而是讲经济学的思想是如何演化而来的。摘录其中对思想史概念的几个解释：零散的经济思想有别于系统的经济学，经济史不同于经济学思想史，经济学思想史是对经济学核心议题的反省。估计现在很多人都遗忘了经济学的本质，其实是一门研究幸福的科学，在马歇尔的定义里是人类社会和个人的“较好生存”([wellbeing](http://www.econlib.org/library/Marshall/marP1.html))。那区块链的本质是什么呢？本手册通过对其核心原理的不断拷问，提出的观点是：**区块链不论如何称呼，其背后的技术以及发展方向，是自然规律中隐含的一种用于修复人类社会性缺陷的一系列规则设计，最终达到人与人，人与机器的完美协同**。

这里所说的社会性缺陷，在很早的社会协作里就已经被深刻的意识到了。现在常说的去中心化的问题，也只是这种社会性缺陷的一种表现形式。严格意义上说，去中心化不一定优于中心化，本质上还是要看社会性缺陷是什么。圣经里“[巴别塔](https://zh.wikipedia.org/wiki/巴別塔)”的故事，隐喻着人类的沟通障碍是上帝特意安排来限制人类发展的。而电影“[罗生门](https://baike.baidu.com/item/罗生门/9732555)”进一步阐述了不同的主观观察者，对同一客观事物也会产生认知偏差，就像本文开头所说的，背后受每个观察者动机的影响。甚至有非常极端的思想实验，在一个每个人都能当面阅读对方思想的城市里，一个完全透明的城市，可能比罗生门的世界更加可怕。面对这种无法改变的人性，为了维持人类社会的组织，其实已经设计出了很多的社会制度。这些制度有的偏向中心化，有的偏向去中心化，背后都是在适应不同的社会性缺陷，重建社会的信任。对此已有不少理论研究，但这些设计的出发点，始终是人类管理自己，而区块链可以说是利用宇宙规律来管理自己，是一大进步。这一进步的历程才刚刚开始，很多数学原理被重新评估并运用到这一体系之中，也不失为人类探索基础科学的一大回报。但这一波的进程能够推进多少，是否真的对社会有益，都还不得而知。但至少我们愿意相信，茫茫宇宙中，蕴含着这样的宝藏，等待人类去发现。

张翔  
2018年5月7日凌晨

# 信任的来源
社会需要信任，区块链修复信任，但信任到底是什么？当每天早上我们睁开眼睛，如何知道我们还身处同一时空？如何确信今天的太阳会升起，而且还是昨天那个太阳？每次和家人相见，如何知道对面的就是你的亲人？看似习以为常的东西，在我们反复叩问下，展现出其异常神奇的一面。我们可以先下一个简单的定义：**信任是对于事物连续性预判的把握程度**。在这个定义下，信任首先不是有无的问题，是程度的问题。科学带来了多次的工业革命，其背后就是因为对事物预判性的把握程度达到了前所未有的精度。牛顿力学带来了我们对简单机械的信任，电学用信任取代了最初对电的恐惧，相对论和量子力学让我们有勇气去探索更大的宇宙空间，也能够从最小的粒子中获取能量。但是决定论在量子理论和混沌理论中遇到了极大的阻碍，这预示着“对于事物连续性预判的把握程度”可能是有上限的，而这就是信任的极限。在信任的上限和下限之间，充满了各种人类社会的信任问题。

在对社会学信任进行展开之前，我们还需要翻开信任这枚硬币的另外一面：事物本身的可预判性是固定的，而信任的差异源于主体对信任对象的认知。人类是认知能力最强的生命体，也是唯一系统性发现和利用宇宙规律的生命体。刚性物体的力学性质最简单，也最容易认知理解；生物的化学性质较复杂，要基于大量现代化的观测手段才能认识其中的规律。所以认知能力受到信息获取手段的制约，幸好计算机科学的发展，使我们拥有了处理海量信息的能力。但是在人工智能领域，数百万乃至上亿节点的神经网络模型虽然能够提供很好的预测能力，但我们对其原理仍一知半解。所以认知能力也受到理解力的制约。回到社会学的信任问题上，在简单的测谎实验里，有靠机器进行大量数据采集分析获得的测谎结论，也有专业人员依靠观察和直觉判断的结论。但不论是基于信息的还是基于理解力的，都只能达到非常浅层的连续性预判，也就是信任。理想情况下，如果我们能够知晓对方所有的思维，而且掌握了完备的博弈理论，那么在这种信息完备，且完全理性人的假设下，可以建立完美的信任社会。但很遗憾上述两个假设都不成立，所以社会学里的信任是需要刚性制度去约束的，也就是契约。

我们逛超市，完成每一次看似轻松的交易，我们和商家的信用，如果没有契约的约束，将是及其脆弱的。但参与这个简单交易的信任元素其实非常多：商品生产厂商的品质，质检部门的尽职，物流的可靠，货品信息和标价的完整，收银结算的透明，异常问题的反馈等等等等。针对如此多的约束条件去设计契约是非常困难的，我们需要更加巧妙的方法：**对于社会群体的信任源于经济学原理**。以最简单的收银机举例，如果开发收银机软件的程序员埋了一个隐藏的后门用以窃取客户的付款资金，那么他有两种选择：开发通用的后门大量窃取资金，或者开发针对性的后门只在特定情况下窃取特定用户的小量资金。第一种情况下，开发成本相对较低，但是金额大非常容易被发现。第二种情况下，开发成本很高，收入反而降低，需要很长的时间在运气足够好没有被发现的情况下才能获利。所以最终这个程序员放弃了这个计划，在法律缺失的一些角落里，经济规律仍然起着作用。区块链最基本的作用就是解决了社群协作的信用问题，而我们对于区块链的信任，一方面基于对密码学和计算机代码的认知，另一方面也基于其按经济规律设计的契约规则。

## 信任的区块链演化

如果说区块链承载了信任和交易，那么我们也不能忘了硬币的反面，也就是恶意。通过善意和恶意的不断碰撞，我们才能充分理解区块链如何解决交易信任的问题。从世界上只有两个人的时候说起，在丛林法则里，是面对面的恶意。这时的博弈场景正好满足囚徒困境的条件，假装合作，然后侵吞对方会带来最大收益。但当双方都意识到对方的策略，采取规避态度时，合作的可能也消失了。直到环境的压迫足够大，任何一方都无法独立生存的时候，经济动力使合作与信任再次成为可能。合作的久了，人类产生情感，这为更大范围的合作信任建立基础。

我们暂且把这个合作的温床比喻为一个小岛，叫做比特岛。这里有两个人“阿稳”，和“阿北”。他们每个人都掌握一定的生成技能，需要交易合作才能生存。而且聪明的两个人已经约定使用贝壳作为记账工具来记录和换算两个人的资源交易。一开始他们住岛的东面，生活在一起。因为所有交易对双方都是透明的，所以在交换贝壳和物资的时候，双方都会对数量进行确认，一旦出现误差，可以回退到交易前的状态重头开始。这就是区块链的隐形基础，网络通信协议。这个通信层作为整个互联网的基础，就像空气一样，大家已经习以为常了。

经过了1个多月，阿稳和阿北积累了足够的物资，打算出门，分头去探索比特岛的其他区域。阿稳往南走，阿北往北走。我们把时间拨快，一年后，阿稳盘踞在岛的南面，阿北占据岛的北面。他们发明了可以远程通讯的工具，但是双方的相互猜疑让两个人不敢见面。他们殖民了岛上的原住民，让他们传递货物。阿稳尝试给原住民1个贝壳，让他去阿北那边换1个香蕉。可过了很久都没收到，两人通讯后发现原住民拿贝壳跑了。阿稳思考后换了一种策略，他打造了一个保险箱，把贝壳放在里面锁上，交给原住民A，传递给阿北。等A走后再把钥匙交给另一个原住民B，传给阿北。阿北拿齐保险箱和钥匙之后，打开箱子，取出贝壳，放进香蕉。再用同样的方式分批传递给阿稳。两个人用这样的方式，成功进行了几次交易。

但是好景不长，某天传递保险箱的原住民A和传递钥匙的B相遇了，他们很快发现钥匙的使用方法，联手把贝壳拿走了。阿稳并不气馁，他把制作保险箱的方法教给了阿北，他们每个人都做了10个自己的保险箱。双方保留自己的钥匙，但把空箱子通过原住民传到了对方手中。这一次阿稳把贝壳放进阿北制作的箱子里锁上，找原住民直接交给阿北。因为箱子是阿北制作的，钥匙只有阿北自己拥有，所以原住民没办法窃取箱子里的物资。他们俩的这种方法成功使用了很长时间。在区块链里，这种钥匙和锁的错配，就是**非对称加密**。比特币的收款地址就好像这把公开的锁，比特币支付到了这个账户，就是被这把锁锁上。只有地址所有人能够花这笔钱，因为私钥密码，也就是钥匙只有地址所有人知道。而这把锁和钥匙的生产我们稍后介绍。

原住民每天传递着无法打开的箱子，非常懊恼。有一天终于怒气爆发，把阿稳刚交给他的箱子直接扔进了海里。阿稳换了其他原住民又试了几次，还是被扔进海里。这样下去，贝壳总有一天要被耗光。所以阿稳提出了一个大胆的提议：放弃贝壳，直接用纸条来记账。双方先约定初始账户皆为0，阿稳要向阿北买香蕉，就在纸条上写：
> 阿稳支付给阿北1元，阿稳账户余额-1，阿北账户余额为 1

纸条的成本是低廉的，所以阿稳写了很多重复的纸条，交给了所有能找到的原住民。其中还真有一些单纯而空闲的原住民，把纸条交到了阿北手上。阿北收到第一张纸条，验证了收款1元后余额计算无误。阿北收到第二张纸条，计算如果再收款1元，自己的余额应该为2，所以第二组纸条不正确，直接作废。如此看完所有纸条后，他确定阿稳支付了自己1元钱，于是对应的把香蕉放进盒子里寄给了阿稳。如此一来，原来单线的货币贸易，变成了并行式的账本系统，这就是区块链里所谓**分布式账本**的起源。到这里为止都没有出现任何代币，因为交易的本质是账本，而货币只是纸质不记名账务的一个便携表现形式。另外那个箱子里的香蕉如何保证不会被扔进海里呢？这个问题在后面“从移动比特到移动原子”的章节单独讨论。

如此有效的交易协议，也没有坚持太久。某天原住民突然发现，自己可以轻易的伪造交易。他们打造了自己的箱子和钥匙，自己写了纸条：
> 阿稳支付给阿北1元，阿稳账户余额-3，阿北账户余额为3

阿北看到纸条，如约把香蕉放进了原住民的盒子里，而原住民顺利的用自己的钥匙取出了花阿稳的钱骗来的香蕉。阿稳得知后非常恼火，要求勾销这笔交易。但是阿北的香蕉已经消费了，所以无法撤回。阿稳苦想了很久，设计了一种透明的盒子，里面每张纸条都用自己特殊的笔迹进行签名，并把这个方法同步给阿北。从此阿北只有确认这个签名是阿稳的，才会接受那张纸条的交易信息。这就是比特里使用的**椭圆函数签名**。阿北很感谢阿稳的发明，决定把被盗的1元还给阿稳。当阿北向阿稳支付的时候，他只要用自己的钥匙打开这个盒子，在上一次账单下叠加新的支付请求，并签上自己的名字，用阿稳的保险箱锁住即可。保险起见，我们再在账本里加上时间戳，并且尽可能多的复制和广播这个账本。
> 2018年5月1日 17:30:00 阿稳支付给阿北1元，阿稳账户余额-3，阿北账户余额为3 ;
> 2018年5月2日 13:50:00 阿北支付给阿稳1元，阿稳账户余额-2，阿北账户余额为2 ;

到此为止，比特岛上阿稳和阿北发明的这种交易记账法，可以说是比特币协议的变形，我们暂时称其为“**透明保险箱签名记账余额开放协议**”。其中“余额开放”的意思是不强制账户平仓，这个问题在下一个大章节再深入讨论。回顾设计期间每次的规则修改，都是为了避免恶意中间人的攻击。最终结果是一套不受中间人意志影响的可信任的交易规则。但是其中承诺的锁和钥匙不被破解的配对关系，以及无法被伪造的签名，要如何让人信服呢？这里就需要召唤数学家出马了，只有上述元素被充分证明，且用户充分的理解和认知，我们才敢说区块链保证的交易信任是优于目前的三方交易体系的。因为最开头我们定义了，信任是对事物连续性预判的把握。而基于数学的预判精度，远高于对人类行为的预判。但现在这个版本，仍然有缺陷，后面我们还会不断扩充优化这个协议，以进一步提高其可预测性。

## 可以验证的科学
上述可信的交易记账协议里，留了两个数学问题等待我们解决。但这两个数学问题的证明及其复杂，甚至仅仅是使用这两个原理都不是一般人能够做到的。那我们可以相信这些我们无法理解的科学吗？幸好科学本身具有很要的一种性质：问题可以被清晰的描述，而结论可以相对容易的验证。基于这两个性质，我们下面要举一个史上最贱的数学题为例，来告诉大家，看似难以理解的数学，其实其可靠性是非常容易证明的。这道题及其解答来源于[Quora](https://www.quora.com/How-do-you-find-the-positive-integer-solutions-to-frac-x-y+z-+-frac-y-z+x-+-frac-z-x+y-4)问答网站，并由[知乎网友](https://zhuanlan.zhihu.com/p/33853851)授权翻译。

这道题的题目是如下这张图片，第一眼看到的时候，你绝对会以为这又是什么脑筋急转弯的趣味问题。在我们开始枯燥的数学之前提醒读者，只要你看明白了问题，而对于证明过程不敢兴趣，那可以直接跳到结尾去验证我们的结论。当然想挑战这个趣味“脑筋急转弯”的朋友也可以跟着我们一步步的进行数学求解。这就是科学善解人意的地方。  
![difficult math](https://raw.githubusercontent.com/linkinbird/blockchain_book/master/pic/fun_math_problem.png)

用a,b,c替换苹果，香蕉和菠萝，我们可以很快得到题目的数学描述，就是解下面的3元方程：  
$$
\frac{a}{b+c} + \frac{b}{a+c} + \frac{c}{a+b} =4
$$

等式两边相乘去分母后可以发现是三元三次方程，这里似乎已经有些不详的预感：  
$$
a^3 + b^3 + c^3 - 3(a^2b + ab^2 + a^2c + ac^2 + b^2c + bc^2)- 5abc = 0
$$

多项式方程很容易找到某个特解，比如说， a=−1 ，b=1, c=0。但这些解还要带回原方程以确认分母不为零。  
这意味着我们的立体方程（3维）实际上是个椭圆曲线  
但这里不是大家熟悉的圆锥曲线中的椭圆，而是域上亏格为1的光滑射影曲线。  
对于特征不等于2的域，它的仿射方程可以写成：   
$$
y^2=x^3+ax^2+bx+c
$$

复数域上的椭圆曲线为亏格为1的黎曼面。Mordell证明了整体域上的椭圆曲线是有限生成交换群（有限域），这是著名的BSD猜想（世界7大难题）的前提条件，所以我们就不在这里费劲的解释细节了。  
现在我们需要把椭圆曲线化成魏尔斯特拉斯（注：Weierstrass，提起他最著名的成就就是严密化微积分的ε-δ语言）形式。这是一个长得像这样的等式：  
$$
y^2=x^3+ax+b
$$

即使你不知道如何完成变换，验证它也是很容易的，或者说至少是机械的。对于我们而言，需要的变换由令人生畏的公式导出。  
$$
x=\frac{-28(a+b+2c)}{6a+6b-c}
$$
$$
y=\frac{364(a-b)}{6a+6b-c}
$$

得到的这个方程尽管看起来和原方程长得不怎么像，但确是如假包换的可靠模型  
$$
y^2=x^3+109x^2+224x
$$

在图像上它长成这样，一条有着两个实部的经典椭圆曲线，右边的“鱼尾”连续延伸至正负无穷。左边的封闭椭圆曲线将成为解决问题的契机。：  
![oval plot](https://raw.githubusercontent.com/linkinbird/blockchain_book/master/pic/Elliptic_function_plot.png)

我们略过一些内容，直接找到一个很好的有理数点x=−100, y=260，通过下面的等式还原对应的a,b,c  
$$
a=\frac{56-x+y}{56-14x}
$$
$$
b=\frac{56-x-y}{56-14x}
$$
$$
c=\frac{-28-6x}{28-7x}
$$

得到的a,b,c乘以公分母14，就变形为 a=4,b=−1,c=11。带入原方程，验证确实等式结果为4。只可惜这个解有一个负数，不满足题目的条件。但至少我们验证了上述的变换是成立的。  
$$
\frac{4}{-1+11}-\frac{1}{4+11}+\frac{11}{4-1} = 4
$$

现在一旦你在椭圆曲线上找到了有理数点，就可以利用弦切技巧进行加法，生成其它的有理数点（有理数的加法是封闭的，有理数加有理数还是有理数）。这种加法叫做椭圆曲线加法，相同点做切线，不同点做连线，取交点的垂足镜像，形成“有限加法循环群”  
![oval plus](https://raw.githubusercontent.com/linkinbird/blockchain_book/master/pic/Elliptic_function.png)

一开始，我们可以通过作P点(x=−100, y=260)的切线，找到它和曲线再次相交的点，以此增加P点的值。结果开始变得有点吓人  
$$
P+P=2P=( \frac{8836}{25},\frac{−950716}{125})
$$

这个新的点也对应一组a，b，c的值 (a,b,c)=(9499,−8784,5165)，很遗憾这组解也有负数。

我们继续计算3P=2P+P，计算4P，5P等等等等，直到我们计算到9P，对应的a, b, c的值就非常恐怖了  

```
a=154476802108746166441951315019919837485664325669565431700026634898253202035277999,  
b=36875131794129999827197811565225474825492979968971970996283137471637224634055579,  
c=4373612677928697257861252602371390152816537558161613618621437993378423467772036
```
终于这里没有负数，而且经过很简单的计算机验证，确实满足求和为4的方程。这就是这道题的答案，一个80位数的答案，显然是不可能通过瞎蒙或者暴力手段去破解的。你不一定看得懂过程，但是可以简单的验证答案，那么就姑且相信科学是对的吧。

“**透明保险箱签名记账余额开放协议**”里无法篡改的签名，就是比特币协议的基础：椭圆曲线加密算法 ECC (Elliptic curve cryptography)。没错，这里的椭圆函数，就是史上最贱数学题里的椭圆函数。他对于数字的单向放大能力，造就了签名算法容易生成，容易验证，但是难以破解的特性。他和量子时代的OTS单次抗量子签名一样，成为了区块链信任的基石，被用到不同的项目里。需要提醒的是，上述我们自己创造的协议，加上区块链的数学工具，仍然和真正的比特币协议有些许差异。我们不打算在这里解释具体的比特币交易协议是什么样的，但是通过我们对信任的剖析，对交易的推导，相信大部分读者已经可以理解比特币颠覆性的运作机理。“信任源于认知”，而对于没有看过比特币源代码的人，我们只需要相信基本的经济规律，世界上这么多聪明人在没有串通的情况下，一致认同且投入大量的精力物力在比特币之中，他们不是为了骗你的那一点钱，这样不经济。“对于社会群体的信任源于经济学原理”，所以当比特币和区块链已经是社会群体现象时，对他的顾虑可以打消了。

## 去中心化的进击
我们自己发明的“**透明保险箱签名记账余额开放协议**”，已经完全可以应用在现有的交易系统里，即使这个系统是中心化的也没问题。因为我们在开头已经说了，区块链只是用于修复社会性缺陷。以银行会计为例，据统计有[27.5%](https://www.accountingweb.com/aa/auditing/human-errors-the-top-corporate-tax-and-accounting-mistakes)的会计从业者都曾在系统中录入错误的数据。只要在交易和授权这一层用上区块链的加密协议，再加上一个三方见证，就可以修复这种人为因素导致的社会交易缺陷。另外从经济学角度讲，银行和国家的政策也是博弈平衡的结果，在大经济环境的约束下，银行对个人有意作恶的投入产出太低，也就失去了作恶动机。所以最早的区块链金融应用比如[Ripple](https://ripple.com)，被很多人批评过于中心化，是一种误解。但不可否认区块链确实蕴含着更大的野心，这个野心不是改造银行交易业务那么简单。在全球化的视角里，中心化最大的风险是超越国家的系统性风险，也就是国家遭受重大打击，金融体系崩溃，记账系统瘫痪，交易无法进行。面对这种情况，简单的分布式，多机房可以解决硬件问题，但是仍然解决不好人的问题。所以区块链索性彻底放开账户管理的权限，所有人都可以参与见证。这些见证者是超越国界的，但却被赋予了非常土的名字：矿工。银行业的区块链项目，没有甘于做矿工的，都想打造自己的平台。但银行不可能推出真正去中心化的产品，因为他们是旧体系的受益者，这是经济规律决定的。所以去中心化的进击主力，将会是另外一群人。

去中心化可以理解为对于人类社会缺陷的更深层修复，我们还是以比特岛为例来推演和放大这种缺陷。今天“比特岛”上发生了大事件，有一种恶意病毒肆意的传播。感染的人会记忆模糊，分不清敌友。他们疯疯癫癫，时而胡说八道，时而思维清晰，导致整个岛上没有一个人是可信的，包括阿稳和阿北。这时能够依赖的只有科学，所以钥匙和锁，以及数字签名都还正常工作。感染了病毒的阿北，开始胡乱记账：
> 2018年5月1日 17:30:00 阿稳支付给阿北1元，阿稳账户余额-3，阿北账户余额为3 ;
> 2018年5月2日 13:50:00 阿北支付给阿稳1元，阿稳账户余额-2，阿北账户余额为2 ;
> 2018年5月3日 11:35:00 阿北支付给阿稳1元，阿稳账户余额-2，阿北账户余额为2 ;

阿稳拿到账本简单计算就可以发现第三条支付之后的余额没有按规则变化，而如果自己擅自修改的话，阿北也可能不认账。所以阿稳打算把验证账本的权利，交给岛上剩下的意识清醒的人，以防阿稳自己哪天也感染了病毒。但是哪些人是清醒的？阿稳设计了一个小测验，做加减法。“透明的带锁带签名账本”被无限复制，分发给岛上所有的原住民，盒子上有100道题的算术小测验，原住民独立算完之后，跑到岛的中间比对答案。答案一致，且最快计算出来的，可以给自己的账户增加1元钱。这笔交易最后由帮他验证答案的其他原住民一起签名，达成共识。那些意识模糊，或者恶意捣乱的，因为测验答案不通过，所以被排除在账本见证权限之外。留下那批意识清醒的原住民在无需打开盒子的情况下检查这个“透明的带锁带签名账本”的合法性并投票。这些原住民就是矿工，获得的记账奖励就是挖矿，交易的投票验证就是**共识机制**。之前阿北胡乱记账的内容就因为不合法而被抛弃，仍然以上一周期的账本为准。比特币利用更巧妙的一种小测验形式，保证小测验的答案和账本的内容耦合在一起，当原住民算完小测验之后，他验证的那个正确账本也被锁定，无法篡改。感兴趣的朋友可以去阅读比特币的白皮书或者代码文档，到此为止，我们的加强版记账协议就和比特币一样做到了广义上的公开透明不可篡改。

原住民通过帮助阿稳和阿北记账，自己也积累了一些“小金库”。那些记忆模糊的原住民显然无法撼动这个系统，但是意识清楚的原住民中，也分裂出了恶意分子。因为每一笔记账经过钥匙和签名的双重保障，所以要篡改别人的账本内容是不可能的。而如果只是捣乱干扰验证，也并没有任何经济收益。但某一天这些恶意分子发明了一种**重复消费**(double spending)的诡计。邪恶原住民转账1元钱给友善原住民买一个香蕉，转账记录签名锁好交到岛中央进行验证。友善原住民看到记录后把香蕉交给了邪恶原住民。谁知邪恶原住民同时发起了另外一个转账，将同样的1元钱（尚未支付给友善原住民时的账本状态）转给自己，用自己的签名和锁锁上。这时在岛的中央出现了相互冲突的两个记账版本，这一元钱有的说支付给了友善原住民，有的说还留在邪恶原住民那里。见证者分为了两派，也都分别完成了自己的小测验。但是有效账本只能有一个，这时投票是唯一的方式。只要邪恶原住民相互串通好，超过50%的投票比例，就可以把白的说成黑的，完成这种“重复消费”攻击。比特币协议也存在这个风险，如果矿工严格按照现在的代码执行，那么哪怕发现了冲突的账本，也只能认可那个票数多的版本。

有没有办法避免这种攻击？我们虽然无法改变恶意矿工，但是至少我们可以隔离他们，产生分叉，将善良矿工保留在一个社群里持续运作。这里我们要介绍一种创新的**意外流行算法**([surprisingly popular](http://news.mit.edu/2017/algorithm-better-wisdom-crowds-0125))，很多时候真理真的掌握在少数人手里。比如我们在街头调研，澳大利亚的首都在哪里，相信大多数人第一反应会是“悉尼”。但是我们现在多问一个问题：你认为别人的答案会是什么。就是这么一个小小的改变，带来了意外的效果。大部分人会认为自己的答案和别人的答案都是悉尼，而真正的内行人知道澳大利亚的首都其实是堪培拉，而且一般人会误以为是悉尼。还有一部分一知半解的，可能会觉得墨尔本是正确答案。通过两道问题的统计，只要有足够多内行存在，我们就会发现堪培拉会是那个“意外流行”的答案，也就是自己回答堪培拉的比例，要显著高于“以为别人会回答”堪培拉的比例。内行越多，这个意外流行的程度的就越大。只要10%的专家存在，就有足够把握获得正确的答案。

将这个算法应用到比特币协议中，矿工除了验证正确的那本账本以外，还需要留意异常的节点变化。进行”重复消费攻击“时需要在一段时间内将51%算力隐藏，在攻击者释放这部分攻击算力的时候，是有迹可循的。一种攻击方式是，平时对外同步正确的账本，攻击时突然拿出另外一个版本的账本。那么善良节点通过观察该异常节点前后账本间的矛盾就可以预判恶意攻击。另一种攻击方式是平时只维护那个攻击账本，不与外界同步，在攻击时直接释放攻击账本。那么善良节点对于历史不明的新节点要隔离同步，并行保存自己验证的版本，和那些新节点意外流行的冲突版本。最后在善良节点一致识别出攻击节点后，可以进行隔离分叉。这是一个全新的比特币升级协议，目前还没有人实现过，但可以预见的是，这将对系统产生更多额外的开销。

到底去中心化要到什么程度？对风险的防范是否要做到极致？目前比特币交易速度慢，成本高已经是其最为诟病的问题，这就是完全去中心化的代价。一个简单的交易，要动用这么多见证者，还要做那些无意义的算术题。过度的去中心化和风险预防显然会导致效率低下，资源浪费。一个人出门要带伞预防下雨，要带厚外套预防降温，要带现金随时消费，要带医疗包预防受伤，要带户口本预防突然警察查岗......那这样的生活就失去了意义。为了解决比特币这种负面作用，大量的升级协议，比如持币者权重(Proof of stake)，委托权益共识(DPOS)等等，试图用更低的成本来达到群体的信任。他们的可信度是否服从经济规律，是否经得起人性的考验？我们拭目以待。

## 用户社群的变化
在区块链的去中心化时代，每个人，每个个体的身份也面临着转变，他们的组织形式面临重组。想象如果是一个中心化的组织，去攻击现在的货币和银行体系，那么国家机构能够非常方便的找到带头人，并予以控制，这个组织不攻自破。而去中心化的区块链，在安全情况下可以使用半中心化的共识机制来提升效率，而面临外部威胁的时候，又可以迅速转变到完全去中心化模式以自我保护。国家在调查这种区块链组织时，会发现每一个人都是全节点。就好像收集签名时大家围着一把雨伞循环签名，首尾相接，找不到谁是第一个，谁是最后一个。也正是这种组织形式，即使内部有人作乱，也很难真正影响到总体。

比特币在2017年就经历过巨大的冲击，但是他挺过来了，这为比特币的价值提供了最佳的保证。这个冲击就是网络分叉，就好像善良的原住民和邪恶原住民在规则设计上产生分歧，要分道扬镳。唯一的差别是，这里并不区分善恶，只是选择的不同。这个分叉的目的是要解决比特币交易缓慢的老问题。经过开发者社区和矿工代表的磋商、妥协，最后分为两个阶段：第一次分叉是比特币核心开发者社区提出的，在不改变底层协议基础上，创建上层共享账簿 [lightning network](https://lightning.network) 。交易双方在主链一次性提取共同基金，就可以在私有通道里多次交易，方便快捷。而第二次分叉是比特大陆等矿工代表基于"[New York Agreement](https://medium.com/@DCGco/bitcoin-scaling-agreement-at-consensus-2017-133521fe9a77)"发起的SegWit2x。主要目的是将区块大小从1M扩容到 2M，这样全网账簿的体积也会扩大，门槛会提高，影响区块链的去中心化程度。对照下面比特币价格图表我们可以看到，第一次分叉提升区块链交易能力，带来了小幅升值。而第二次分叉因为太多的经济利益和政治思维，忽视中小玩家导致了最终分叉失败。这反而证明了比特币去中心化不可篡改的能力，所以带来比特币价格的飞跃。  
![image](https://raw.githubusercontent.com/linkinbird/blockchain_book/master/pic/bitcoin_charts.png)

这一轮行情之后，大量的普通百姓，开始把自己的资产转移到这个基于数学和经济原理的去中心化网络之中。为了保证全流程的安全，比特币地址的私钥（保险箱的钥匙）和签名都需要妥善的保管。但因为数字秘钥是一长串无规律的数字字母组合（32字节），人类记忆又是如此不可靠，就催生了数字钱包这个产品。最安全的是使用桌面版的离线开源钱包，并将长串秘钥写在纸上保存。在需要交易的时候，先断开网络，填入收款信息和秘钥进行签名。然后重新联网，将交易信息和签名结果同步到区块链网络，完成验证。但这样显然非常麻烦，完成一次交易可能需要10分钟的手工操作。便捷一些的是联网钱包客户端，可以是桌面或者手机版的。把秘钥保存在本地的某个文件内，这样在交易时只要复制粘贴即可。在客户端不被病毒攻击的情况下，是安全的。最方便快捷但也最不安全的就是交易市场，在交易市场你只要用邮箱注册一个自己的账户，输入较短的日常密码就可以交易。但背后真正关键的区块链地址私钥，是保存在交易市场服务器上的。一方面面临交易所主动的作恶风险，另一方面也面临交易所被黑客攻击的风险。

未来参与区块链的个体，可以用身体来管理秘钥。虽然人的意识是不稳定的，但比如指纹，声纹，虹膜，面部特征等都可以用作独一无二的特征。我们可以将指纹作为随机数种子，用面部特征进行非对称加密。这样在支付时要先清醒的说出某些短语，然后用指纹验证密码段的匹配，最后完成交易签名。但不论怎么设计，这些工具都需要经过验证，传播和使用。随着科技的进步可能还会有工具的升级，账户、平台的转换等等。为了确保中间步骤的安全，我们还是要加强自身的认知理解力。比如遇到[IOTA](https://www.iota.org/)这类使用一次性签名的区块链项目，在搞清楚每次支付以后账户地址不能复用这种操作细节之前，千万不要轻易尝试。

到此为止，我们通过一层层的推理走过了和比特币创建者一样的道路。一路上有对现有比特币的认同，有对完全去中心化的批判，也发明了对比特币防御体系的改进算法，但这仍然不是区块链的终点。就像最初定义的，**区块链是为修复人类社会性缺陷而存在的**。我们后面还要继续叩问更加深刻的问题，发现更加隐蔽的社会性缺陷，并设计和重构区块链的未来。

# 为什么需要货币

区块链修复了交易信任问题，但比特岛上的交易似乎和我们日常的交易很不一样。在整个区块链设计过程中，核心的账本实际上替代了所谓的货币。就好像在移动支付如此便捷的今天，我们口袋里的纸币越来越少了。所有的交易也不过是数字的加加减减，那货币真的是必须的吗？在回答这个庞大的问题之前，我们先问一个更加具体的问题，我的货币余额可以小于零吗？

## 余额为负的账本
我们回到科学的范畴里寻找答案。世界上有火，也有水；有阳极，也有阴极；有正面，就有反面。而在金融的范畴里，我们有债务，也有债权。如果取债务平衡的起点为零点，那么债务可以用负数表示，而债权就是正数。数学的完美对称，使我们完全可以将金融体系纯数字化。不论债务还是债权都可以计算利息，因为债务为负，所以利息也为负要支付给债权人。债权人的利息为正，就是收取债务人支付的利息，最后两者平衡，求和为零。一般性债务不可怕，因为你可能同时也是别人的债权人。所以看上去在金融和会计的眼里，账户余额是完全可以为负数的。

但数学中负数的发明和会计学都是后来才有的，人类最初的贸易里，使用的是实物记账。比如比特岛上曾经也用过的贝壳，还有后来的黄金，白银等等。描述这种实物数量的数字，叫做自然数。因为物质不能为负，所以自然数里没有负数。比特币不假思索的继承了这种自然数的特性，但现在我们重构区块链，设计一种账本余额可以为负的“**比特平衡账本**”。

在比特平衡账本初始化的时候，任何人的账户余额都为0。支付交易时，支付方余额递减，收款方余额增加，系统总和仍然为零。这相当于一个熟人的赊账平台，只要双方没有异议，任何一方都可以存在负余额。负数账户向其他账户支付时，看似收款账户的余额增加了，没有拒绝的理由，但实际上每次支付背后都存在等价的物权或者服务转移。如果收款方无节制接受负账户的支付，兑换物品，那很可能面临事后自己的账户正余额无法消费的问题。因为负账户的债务人在消耗了赊来的物资和服务之后，变得懒惰，不愿意提供其欠款的等值服务。最后某一方负数太大时，债权人只能要求强制平仓，对方没钱就替其劳动还债，或者卖身。

当交易人数增多时，情况会变得有点复杂。有些人相信这个债务人，愿意接受其负账户的付款，而另外一些人不相信他，就不接受其付款。这背后代表的是这个人的信用，这里就完全和现实世界的金融体系对接了。每个人出生的时候，是没有信用的，也就没有钱，不能买东西。但是他们的父母为社会创造了价值，余额为正，可以将余额转移给这个新生儿，帮助其成长。新生儿长大，毕业以后，父母的资助也停止了，这个人的账户重新清零。他需要工作先积累自己的账户余额，然后去消费自己喜欢的东西。当然也有人贷款买房或者融资创业，前提是别人能接受他的负账户支付来兑换实物资产或者创业资源。但这里有个漏洞，我接受了负账户的付款，我再用这个款项支付给别人来兑换物资，我就不吃亏了，相当于债务的转移。这个问题在于负账户的流动性，负账户的付款不是通用现金，而是债务的证券化，简称债券。理论上收取了负账户的付款，只能反过来再支付到负账户身上。看上去金额不变，但是因为负账户所有者的生产力或者偿还能力有限，所以这个债务债券，是会贬值的。

为了解决负账户付款的流动性问题，我们引入债券的定价功能。首先这个定价权不能由债务人和债权人来行使，因为他们是利益相关方，会虚高定价。那在区块链里面，最合适的就是由矿工来定价了。每个矿工可以设置其能接受的某个负账户债券的折扣率，比如一个信用一般的人，他支付10元债券，其实只能当7元通用现金来使用，折扣率70%。足够多的矿工接受该负账户的债券后，交易被验证，从负账户里扣除10元，而收款账户获得7元。参与验证的矿工可以分得10% 0.7元手续费。约束矿工定价权力的是经济原理，因为他通过越多的负账户付款，区块链就会通货膨胀，他手里的挖矿收益就会递减。但如果他不通过任何负账户付款，而有其他矿工通过的话，他就拿不到收益。与矿工博弈的是负账户，也就是债务人，他们发起拍卖交易，只有折扣率满足他的底线，而且足够多的矿工同意，交易才能成功。在矿工和卖方讨价还价的博弈下达到区块链的流动性管理。交易结果对收款方是无差的，因为他就是收到了7元钱，给7元钱的货。这套体系和比特币兼容，因为比特币可以看做是一个特例：就是所有矿工设置负账户折扣率0%，那么所有账户如果支付超过其余额的金额，超过部分都会被清零，也就是余额不能为负。

现实世界的现金，信用，债权，债务已经完全兼容进这个“比特平衡账本体系”。这里的矿工从简单的算术劳作，升级为金融矿工，赚取债券的手续费。系统还可以再加入债券利息，以鼓励更多的矿工参与，并通过调整利率来调整区块链的“货币”流通。当然为了维持区块链的信用，这套利率调整规则也需要按照去中心化的方式去设计。最后我们发现绕了一圈，终于拜托了负账户的约束，但是似乎“货币”这个概念，还是摆脱不掉。因为开放的正负账本体系没有平仓的要求，但是一定有坏账的风险。通过“货币”这种通货的总量控制，可以在无需强制平仓的前提下，保持总体风险可控。可见**“货币”本身就是修复人类社会性缺陷的一种设计，区块链要利用这种设计**，而不是盲目的去改变他。

## 货币和财富
账户余额的正负，除了对应债务和债权，还可以和财富的积累对应。过去积累的财富为正，未来的财富提前使用为负。货币作为财富的记账形式，也只能接纳有限时间的提前预支，以控制不确定性。现实生活中如此复杂的财富形式，以统一的形式表述，也是货币的价值之一。反过来看，可以用货币衡量的，都是财富：股权、品牌，固定资产，预期收益，版权等等。区块链的信任机制使其能够承载交易，而区块链的稳定通货体系，即使在负账本协议内，也可以完全达到货币的财富储备功能。比特币虽然简单粗暴的约定其发币总量为2100万枚，但也基本具备了财富储备的能力。财富是虚拟的，但也是内在统一的。而货币经过了长久的变化，在不断升级。

货币等价物历史上出现过很多，比如比特岛上用的贝壳，但是后来发现发币量不稳定。后来地球储量最为稳定的黄金和白银成为了最佳的货币等价物。但同样稀有的钻石为什么没有成为货币等价物？因为通俗的等价物要满足以下条件：
* 发行量稳定可预估并且难以人为改变
* 首次发现时的等价物分布与财富分布接近
* 等价物质地稳定，不随时间损耗
* 等价物难以人为合成或改造

钻石满足以上第一点和第三点，但碳基的钻石是可以人为合成的，无法满足第四点。即使我们有技术区分人造钻石和天然钻石，并设计定价标准，弥补了第四点也无济于事。最大的难关还是第二点，**新发货币分布要和财富分布接近**。远古时代流通范围小的时候，不论货币最初如何分布，最终都会在部落斗争的过程里达到货币、财富、强权的平衡同分布。后来的城邦文明时期，财富被统治者掌控和分配，所以货币选型是反过来由财富分布决定的。统治者收集金银，并以金银为基础发型货币。帝国争斗时期，金银已经是世界通用的货币标准，所以强权直接掠夺金银和土地，并不需要设计新的货币体系。直到第二次世界大战末期，全球在新的权力平衡下，再粗暴的金银掠夺就显得有些过时。而且连年战争，各国过度兑换黄金造成挤兑困难，导致金本位制度崩溃。所以当时44个国家的代表在美国新罕布什尔州“布雷顿森林公园”召开联合国和盟国货币金融会议，商讨新的货币体系以匹配现在的权力和财富分布。他们达成的以黄金为基础，各国推出固定汇率货币以便流通的体系，就是布雷顿森林体系([Bretton Woods system](https://en.wikipedia.org/wiki/Bretton_Woods_system))。该体系在黄金的基础上，还算尊重历史的财富分配。直到各国完成战后恢复，开始寻求新一轮发展和财富争夺的时候，黄金的初始分布已经成为障碍。美国强权的崛起，使其抛弃了美元和黄金的挂钩。在美国贸易盈余，马歇尔援助计划([Marshall plan](https://en.wikipedia.org/wiki/Marshall_Plan))，石油美元等手段的推进下，美元成为了实际意义的国际货币。而美国黄金储备也拒绝向外界开放，布雷顿森林体系名负实亡。直到1976年，国际社会才象征性的通过了[牙买加协定](https://zh.wikipedia.org/wiki/%E7%89%99%E4%B9%B0%E5%8A%A0%E5%8D%8F%E5%AE%9A)。国际货币的浮动汇率，实际上形成了货币、财富、强权的动态平衡。21世纪中国的崛起也首先反应在汇率市场，和黄金等传统货币无关了。

基于财富、资源和强权之上的货币，是随着时代变化的。每一次货币权利的更替，都会带来或多或少的财富重新分配。而分配过程庞大而复杂，无法保证完美的财富公平。所以每一次都是“货币战争”，以前是真的战争，现在是金融战争。基于现代货币体系的现代金融体系，已经相互耦合在一起。随着借贷的发生，债务和债权的债券化，创新金融资产大量流通。他和货币的交易转换主要基于流通性和价值计算，而杠杆的加入加剧了兑换的风险。如果对全球金融资产强制平仓的话，其规模已经超越了流通货币的承载能力。这就是为什么会爆发[美国债务危机](https://baike.baidu.com/item/美国债务危机)，以及触及国债上限的原因。货币是财富的表现形式，但债务不是。我们在允许账户余额为负的“比特平衡账本”体系里已经验证，需要矿工对债务债券的约束，才能维持整个系统的财富价值稳定。而以美国为首的脱离管控的债务体系，正是区块链需要修复的人类社会性缺陷之一。

## 理解比特币
回到比特币本身，我们暂时抛开那些潜在的货币优化，维持现在比特币的版本，定义交易时验证支付账户不能为负，并将交易单位从最大的比特币到最小的“聪”限制在整数范围。比特币对标现在自然货币规则，并不是要直接替代它，而是提供一个渐进式财富转移认证通道。现在主权国家的货币权和金融权是封闭的，导致财富固化。虽然美国允许个人发币，但小玩家无法获得足够多的支付支持，而大玩家享受现有美元体系的财务积累不愿意改变。中国等国家更是严控金融系统，把发币和金融管控权限集中在党中央。可以大胆想象，如果开放这个门槛，那么Q币等大型公司都完全可以发行自己的货币系统，区块链不是必须的。所以这里比特币冲击的并不是货币本身，其实是封闭的权力系统，也是人类的社会性缺陷之一。这里又体现了经济规律，如果是公司发起这样的冲击，那带头人很容易被质疑，攻击而放弃。但是区块链就好像古代的循环签名，开放且普惠。政府无法确定所谓的带头人，面对大量的参与者法不责众，下不了狠手。这种无形的防御体系留给比特币这个项目一线存活的生机。虽然在很多国家禁止比特币和法币的兑换，但是一旦上链，比特币网络内的交易，还没有人能够阻止。

我们通过6个层次来深入理解比特币：

第一层，交易中间体。革命军要问军火商买枪械，银行转账容易被查，现金交易有危险，所以革命军先用美元买了100个比特币，然后到[丝绸之路网站](https://en.wikipedia.org/wiki/Silk_Road_(marketplace))找军火商。军火交易的时候，将比特币转账给军火商，10分钟区块确认以后，军火商将枪械交给革命军。革命军拿到了货，军火商拿到了比特币，再去交易所里换成美元。虽然比特币每笔交易在区块链里都是公开的，但只记录了虚拟的钱包地址。军火商完全可以建100个小号，分批提现，让监管部门无从查证。这时比特币对美元的价格只要保持稳定，其币值高低对军火交易就没有影响。但尝到甜头以后，大量的非法交易，合法交易都跑到区块链上来，导致通货（比特币流通量）不足，也就带来比特币升值。如今1万美元一枚的比特币体系，能够承载的财富交易总量，是三年前100多美元时期的100倍。但纯粹的交易双方都只是短暂的持有这个交易中间体，所以并没有任何财富的变化。

第二层，交易中间商的投机品，通过囤货、哄抬物价来人为炒作。早期用比特币作为中间交易的商家，发现比特币有升值趋势，所以在卖掉货物，收到比特币支付的时候，不再提现，而是保存起来。比特币升值的越快，供给交易中间体的流通量反而会减少，对区块链体系是不利的。2017年底比特币价格剧烈波动以后，已经很少有人拿比特币做真正的日常交易了。交易所里大部分的买卖，都是投机者低买高卖，或者忍痛割肉的投机交易。之所以说是投机，因为在这一层面，还无法定义比特币的内在价值，所以不存在基于价值回归的投资逻辑，而只有投机。那些大玩家在仅有的流动性里面，可以非常容易的操纵市场，对于想要简单交易的商家非常不友好。索性剩下真正有商品交易需求的人，可以转向USDT([Tether](https://tether.to/)) 这种和美元挂钩的稳定数字货币。这类货币也有中央储备的概念，通过流动性干预来保证币值对美元的稳定。

第三层，赌场代币。假设某一天有人建造了一个只使用比特币的赌场游乐园。里面吃喝玩乐，五脏俱全。赌场越好玩，来玩的人越多，购买代币的兑换率就越高。成功的赌场经营者，可以从代币兑换过程中收到大量过桥资金。用这些资金，他们继续扩充赌场的设施，把赌场建成了一座城市。这个概念在[Second Life](http://secondlife.com/)这种虚拟现实游戏里也同样适用。但有一天大家觉得无聊要退币走人的时候，会导致挤兑风险，强制平仓是无法弥补每个人的损失的。那聪明的赌场经营者，应该在发生这种风险之前，在积累了足够的过桥资金之后，赶快携款走人。需要说明的是，这里的赌场不只是比特币本身的网络，而是以比特币为门户，所有可以和比特币快速兑换的数字货币组成的新经济体。对这个经济体未来前景的判断，是影响比特币价值评估差异的最根本变量。老派投资人比如巴菲特，因为不认同区块链经济体的总体价值，所以对比特币的认知还停留在第二层：投机品。而以矿工、开发者联盟为主体的赌场建设者，对赌场的价值深信不疑，暂时还没有携款潜逃的迹象，是他们撑起了现在比特币的市值。以比特币单价1万美元计算，全部发行完成，比特币会具有210 Billion$的市值。这从侧面代表了这些开发者和矿工共同创造的赌场经济体的价值。

第四层，开发商预售。看到赌场赚钱，很多人也想盖赌场，但是缺乏资金，所以先发行代币来众筹资金，就叫[ICO](https://en.wikipedia.org/wiki/Initial_coin_offering)。这个过程有大量信息不对称和违规操作，但这也是投资区块链的重要途径。好比投资圈的一级市场和二级市场，在一级市场进行风险投资，可以获得更高的回报，但是风险也大。ICO就是区块链项目的风险投资，更准确是天使投资。众所周知天使投资只有4%的成功率，要投过大量的项目，才能从中筛选出真正的好项目。所以没有足够的财力和精力，就不要玩ICO。这里的玩法和天使投资如出一辙，主要参考赌场设计图纸(白皮书，PPT)，建筑工程队质量证书(团队能力)，还有赌场老板不会跑路的信用担保(个人声誉)。一般个人投资者没有这个判断能力，所以更加适合等项目上线，赌场盖好有人进去玩过之后，再进行投资判断。

第五层，国际贸易和生产力。国家间的外汇贸易和一般交易稍有不同，国家货币由国家信用担保不会跑路。所以这个时候我们需要把第三层里的赌场，升级为一个虚拟的主权国家。同时把其他现实中的主权国家，也看做赌场游乐园。比如中国开了赌场自得其乐，赢钱容易。美国人看了都要来，就是美元兑换人民币。那人民币不愿意卖怎么办？美国忽悠说我这里有酷炫的可以上网的电话。所以喜欢用电话上网的人用人民币换给了喜欢赌钱的美元。一国的国力反映了货币的话语权，和发币量一起反映国家的市值。而国力是指管辖范围内的综合生产力。比特币这个赌场如果只是交易中间商，那国力非常薄弱。就像巴拿马，虽然有个非常重要的运河，但是国民生产力落后，都是帮别人赚钱。比特币需要从交易平台扩展到以太坊这样的计算平台，最后通过计算的力量，来支撑区块链经济体的市值。如果没有这层支撑，所谓的比特币价值储存功能，都将是泡沫，财富会流向生产力支撑强的货币平台。2018年3月上线的第一个运行在以太坊的围棋游戏[EthernalGo](https://www.ethernalgo.com/)，算是一个微小的进步，但前面道路还很漫长。

第六层，财富分配。不论是建赌场还是建国，新发货币甚至新型资产都会带来财富重新分配。前面我们也论证了，货币，财富，强权最后是会统一在一起的。所以比特币的财富分配，逃不过现存世界的强权体系。首先持币量最多的个人玩家里，就有和Facebook创始人打官司的“富二代”投资兄弟[Winklevoss twins](https://en.wikipedia.org/wiki/Winklevoss_twins)。据说他们拥有比特币市值的1%。金融玩家也早已入场，老的财富积累在新分配里保有话语权。早期的很多矿工因为长时间的币值波动，没有坚持下来，被后来的玩家攫取了劳动成果。而个人小玩家因为对区块链的认知理解不同，也导致了分配的不同。不过现在比特币在很多国家不被认可，所以有效的财富转移有局限性。未来可能出现更多的区块链经济体，如何在货币，财富和强权间达到新的平衡？似乎天下所有致富的捷径都不能重复走第二遍。

深入理解比特币之后，环顾四周，已经有非常多的新数字货币加入流通。如果只是解决第一层的效率问题，而没有根本上优化货币和生产力体系的话，这些币都无法超过比特币现在的高度。而针对比特币，我们早前的章节已经至少提出两个大的升级建议了。从一个交易，转移财富的平台，升级到真正的货币，金融，经济生产平台，才是区块链真正要走的路。一路上我们会运用数学工具和经济规律，来优化人类的社会性缺陷。

## 区块链上的储物盒
如果说交易是一枚硬币，那货币只是硬币的一个面，另一个面是权利转移(物权，信息权等等)。为了完成这个转移的闭环，我们先设计一个非常简单的转移模型：**区块链上的快递盒子**。这个盒子事先编写好代码，一旦启动就不可更改。盒子和区块链有通信，可以监听区块链上的某些特定事件来做出应对。区块链也不是比特币这种交易链，而是以太坊这样的智能合约区块链。他除了代币叫做以太币ETH外，最大的特点是可以在区块链虚拟机上执行事先发布不可篡改的代码，简称智能合约。稍后我们会单独介绍这个计算的力量，现在我们先借用这个功能，同样通过前面军火交易的例子，来完成区块链经济体的一个闭环交易。

这天革命军要新进一批军火，他们找到了军火商，并把枪械的名称型号等标准化信息提供给了军火商。双方对100ETH的报价达成一致后，开始准备交易。军火商准备好枪械，放进区块链上的盒子里。这个盒子有两个地址，一个是关联的支付账户地址，还有一个是实物的存取地址。卖方发起一个智能合约，由区块链见证之后植入到这个带锁的盒子里，一直到交易结束前，都不能修改。合约内容如下：

```
Loop 统计支付到收款地址的每一个付款方的累计付款金额
If any(支付地址累计付款 >= 100 ETH) then 停止接收其他任何付款
   Try get(向满足条件的地址请求设置取货密码)
     If 设置成功 then 将付款转付到 军火商账户地址XXXXX and 退回其他账户的付款
     else if 等待时间超过1小时 then 退回该账户支付的金额，回到第一步从头开始统计
     else retry
Else If 卖方继续等待 then 刷新统计
Else If 卖方终止交易 then 退回所有支付款项到原账号 and 由卖方设置开锁密码取货
```

卖方设置完毕后把盒子的支付地址和取货地址都发给买方。买方和矿工见证协议无误后，给盒子通电。买方开始向盒子的支付地址打款。如合约设计的，付满100ETH之前，卖家可以随时取消交易。买家不可以单方面取消，但是买家可以和卖家协商。此时钱还没付完，钱和货都锁着不能用，卖家不会恶意阻挠买家的协商请求，因为卖家被锁住的货价值更高。如果此时付款地址泄露给了其他人，这个人也想买货，那公平交易，谁先交钱谁拿货，其他的钱原样退回。

买家没有犹豫，快速付完100ETH之后，收到了在1个小时内设置开锁密码的消息。这时卖家已经不能反悔了，买家设置密码123，完成物权转移。与此同时，盒子账户里的100ETH也如数转移到卖方的军火商账户地址，同步完成资金转移。这样一个区块链上的实物闭环交易就完成了，从此黑帮交易再也不用打打杀杀。但是等一等，黑帮片里经常还会发生另外一幕，就是买回去的货发现是次品，后悔莫及！这是现在很多人将区块链技术移植到线下场景最容易犯的错误，物权在上链前的那一刻，缺乏质检验证。这里因为交易的物品是枪械，我们可以在区块链盒子里预埋一个X光扫描仪，通过扫描枪械结构来判断其真假。但这种方式并不通用，而且不同物品的检查需求千差万别。所以真正要完成交易闭环，还需要一个区块链去中心化的质检服务。

我们把新的盒子改造成一个试验箱，通过封闭的手套可以进入箱子，操作和检查箱子里的物品，但是无法取走。然后像比特岛那样，随机邀请矿工来检查货品。只要诚实的矿工占主导，就可以确定箱子里的货品是否可靠。这种众筹式的实物检查模式，和区块链分布式交易合规检查的原理是一样的，但成本更高。所以再一次我们强调，去中心化不是区块链的目的，我们要在效率和信任间取得平衡。为了优化上述流程，达到真正可用，还需要非常多的工具，等准备充分以后，我们会在后面的章节回来重新解决这个难缠的问题。

# 什么是公平
小时候老师一直教育我们人人平等。但是每个人出生的时间，空间，继承的基因和财富是那么不同，怎么可能做到平等？前面说比特币深层含义是一次财富分配，从目前的结果看，优惠了一部分人，但是把更多的人排除在外。所以经济学有个段子说，如果从现在起，把世界上所有的财富平均分配。那么一周后，还是会有百万富翁诞生，会有人变成乞丐。所以公平不是绝对的，是相对而言的。既然区块链对信任的修复可以做到数学的精度，那么对公平的修复，也许做不到绝对，但是至少能提升。追求公平的终点，最后可能还会回到政治和经济学原理。

回顾中国漫长的文明进程，有句老话“没有功劳，也有苦劳”，这就把公平分成了两个方向。苦劳是你的付出，功劳是你的收获。大量非标和需要创造性的工作里，这两者难以匹配。但是随着工业革命的进程，工作流已经被大量标准化的分拆，在机器的世界里，有机会做到一致的公平。剩下那些非标的内容，我们可以设计一种交易市场，在货币的统一度量下，在多方的交易撮合下，也达到一致的公平。不论是绝对的机器公平，还是撮合下的市场公平，都被用到了不同的区块链项目里。这也是最近区块链发展最活跃的领域。**公平就是在中心化和去中心化之间搭起效率的桥梁**，公平、可信的半中心化，是通往安全高效的道路。

## 工作量的公平 POW

矿工使用asic芯片，是在规则之内为系统创造价值。那些以去中心化为理由反对矿机的人，其内心其实是中心化的，因为他在试图用规则外的方法维护其并不正当的利益诉求。芯片被制造出来，人人都可以购买使用，只要生成过程尊重知识产权。所有专门针对区块链的产权协议Blockchain Defensive Patent License ([BDPL](https://blockchaindpl.org))。

## 权益投票公平 POS
DPOS代理人攻击：假装承诺，骗取选票。或者配合黑脸白脸

但不要为了去中心化而区块链，我们说了区块链是为了修复社会性缺陷。而经济学早就已经证明了，在经济规律面前，少数寡头，只要避免私下协作，就可以保证市场化效率。

NEO 投票权和经济权的分离，防止持币者哄抬物价。

## 机器的公平
数据和机器也需要公平和正义，当人类社会性缺陷被制度补齐之后，人类的协作能力终于可以和机器齐平

物联设备的自治网络IOTA

EVM

# 获得计算的力量
区块链在修复社会性缺陷的同时，能否保证力量不衰减？

当机器获得了意识，其计算的力量如何驾驭？

## 交易的成本
## 空间的扩展
proof of storage
### 传统的分布式文件系统
HDFS
## 算力的扩展
### 传统的分布式计算
spark等等，如何结合
## 人工智能的进击

# 从移动比特到移动原子
如何在物理世界实现区块链的效果？类似[reCAPTCHA](https://en.wikipedia.org/wiki/ReCAPTCHA)把识别人工字体的任务穿插到了验证码识别动作里。我们可以在区块链储物盒交易里做扩展：
1. 苹果已经放好
2. 随机分发100个专家来验证苹果
   1. 每次10个专家到齐以后开箱，确保没有人都换物品
   2. 专家验证后提交意见，并确认锁箱
3. 过半专家确认就可执行交易

但这里如果有一个专家作恶，交易失败，但是也面临物品的流失。移动比特和移动原子最大的差别就是成本。比特可以无成本的复制和转移，所以无效的比特币交易并不会让区块链有所缺损。但是无效的现实交易除了手续费以外，还有很多无法控制的质量流失

解决了质检问题，还可以把物品转移的方法运用到工作量转移上，产生工作任务众筹的区块链平台。但同样的，保证工作质量验证的公平性，是最大的门槛，也许我们还没有准备好。

## 比特机器人
要完全打击作弊的空间，就需要将现实世界机械化，就是机器人化。苹果不是人放进去的，而是机器。苹果甚至不是人种植的，是直接在机器农场种植和管理，然后再投放到区块链里进行交易，最后由机器人运输队实现物流。

那么机器人由谁来建造？机器人是否真的可以信赖？

物权的数字证明化

## 比特人
人的数字化，集信

# 透明和匿名之间
隐私和信任同样重要，因为在前言里我们提到了一种思想实验，在思想透明的城市里，能否建立合作与信任？答案是否定的，因为没有了隐私。完全信息能达到的那种信任强度，能否通过部分信息来实现？在人类社会的信任需求和隐私需求间达到平衡。

上述所有的推导，都是在信息公开透明的情况下实现的，那有没有可能既保证信息的可验证，又实现信息的匿名化？这里需要介绍另外一位可信的科学家

## Layer1 的匿名协议
### Zero knowledge proof
单笔交易本身只记录了address，已经是高度匿名的了，但是通过地址的追踪，还是可以观测到每个币的流向。这个时候在协议层可以通过[zero-knowledge proof](https://en.wikipedia.org/wiki/Zero-knowledge_proof)的进化版 [Non-interactive zero-knowledge proof](https://en.wikipedia.org/wiki/Non-interactive_zero-knowledge_proof) 将交易验证过程匿名化，区块链里的应用叫做[zkSNARKs](https://blog.ethereum.org/2016/12/05/zksnarks-in-a-nutshell/)。基础原理是多项式同态（[中文原理](https://www.jianshu.com/p/b6a14c472cc1)）：
* 加法同态，乘法同态，全同态
  - 对于E(x)函数，难以求得反函数，及无法从E(x)反推x
  - 单调函数，及x≠y,，则E(x)≠E(y)
  - 通过E(x)和E(y)，可以计算E(x+y) 加法同态，计算E(xy) 乘法同态...
* 加法盲验证——用于交易和账本验证
  1. A计算E(x)，E(y)，并发送给B
  1. 因为函数E(x)满足加法同态，B可以通过E(x)，E(y)计算E(x+y)
  1. B独立计算E(7)，并验证E(x+y)=E(7)
     - 但也无法保障x,y没有从原来的[1,6] 篡改为[2,5]
* 多项式盲验证——已知输入，未知EVM代码，验证结果准确性  
$$
P(X) = a_0 + a_1 \cdot X + a_2 \cdot X^2 + ... + a_d \cdot X^d
$$

  - A知道需要验证的多项式P
    - 其中a为计算参数，可以代表某种计算过程
  - B想要验证对应某个不公开s的E(P(s))，及验证某个输入的计算结果是否准确
    1. A和B可以共同选择基于椭圆函数的α对 x⋅g作为E(x)
    1. B计算g, s⋅g , … , sd⋅g和α⋅g , αs⋅g , … , αsd⋅g并发送给A，相当于之前的E(x),E(y)
    1. A同态性计算a=P(s)⋅g，b=αP(s)⋅g并回传
    1. B验证a,b为α对，则A真的知道P，且a值即为B所需校验的E(P(s))结果
      - 存在一种可能，A使用另外的一个P'多项式，也可以找到符合α的a,b对，这种情况叫做“d-power knowledge of exponent assumption”
* 任意计算验证
  - 把任意计算转换为门电路向量
  - 把向量转化为多项式
    - QAP (Quadratic Arithmetic Programs)

### 匿名交易协议
区块链里的应用很多：
* 2016年10月发布的[ZCash](https://z.cash)也是使用类似技术，优化了交易速度，弥补了部分这个技术的短板
* 2017年9月ETH 的Byzantium版本[支持](https://www.reddit.com/r/ethereum/comments/712idt/ethereum_testnet_just_verified_a_zcash_transaction/)了zk-snark proof
* 2018年2月底从比特币[分叉](https://www.reddit.com/r/BitcoinPrivate/comments/7todw0/historical_bitcoin_private_hard_fork_snapshot/)出了[Bitcoin Private](https://btcprivate.org/) (BTCP) 就是merge了ZClassicCoin (ZCL)和BTC主链的一个分叉，采用的也是zkSNARKs
* JPMorgan的[Quorum](https://www.jpmorgan.com/country/US/EN/Quorum)链是基于ETH的金融应用改造，也加入了zkproof和对特定监管节点透明的功能
* ING也有相同道路的项目[zkrangeproof](https://github.com/ing-bank/zkrangeproof)，但看起来有些凉了

## Layer2 的匿名通道和中间方
另一种简单的layer2的方法是一种mixing service中间商服务：把多个付款人，和多个收款人打乱，付款先付到资金池，然后随机轮转之后打乱支付给给收款方。
* Dash的[PrivateSend](https://dashpay.atlassian.net/wiki/spaces/DOC/pages/1146924/PrivateSend)就是这种形式，其隐私性促使其成为暗网的流行交易代币。
* 支付宝在银行的中间账户也可以扮演类似角色，对于央行来说直接隔离了资金流向的明细，所以现在央行要推网联，直接监管每一笔交易。

同样在Layer2的状态通道也可以在交易双方透明的情况下，保持对外部的匿名
* Hyperledger Fabric的private channel就是类似原理

## 算力的匿名化
交易的匿名扩展只实现了匿名验证，但在虚拟机环境里，计算的复杂度更高，简称为[secure MPC](https://en.wikipedia.org/wiki/Secure_multi-party_computation)的问题(Multiparty Computation)。通用的解决方案包括了保密数据分享已经零知识证明等等。但即使看似简单的计算，也需要定制化的协议设计：
* Two-party computation (2PC) 
  * 证明a >b 又称Millionaires' problem
    * The protocol of Hsiao-Ying Lin and Wen-Guey Tzeng
    * The protocol of Ioannidis & Ananth
* Multiparty computation (MPC)
  * 证明数据拥有 [Verifiable secret sharing](https://en.wikipedia.org/wiki/Verifiable_secret_sharing) (VSS)
    * Shamir's Secret Sharing
    * Additive Secret Sharing

通用协议在不同安全等级下还有不同的容错效果：
* 通讯是不安全的
* 中间人是恶意的
  * 恶意的程度 t < n/2
  * 非计划的恶意 Semi-Honest (Passive) Security
  * 计划的恶意 Semi-Honest (Passive) Security
  * 顾忌惩罚的恶意 Covert security
* 直接参与方是恶意的

# 我们在重构谁
如果有一天机器控制了人类，机器之间是否还需要区块链？三体人的世界是否会出现区块链？  
区块链不是自然科学，是应对人类思维的定向技术，是社会科学

人们用区块链去重构他们想要重构的东西，隐藏着自身利益的设计。而真正需要区块链去重构的，却往往被忽视。

## 阶段性的改良
Hyperledger这类账本技术本质上是在对现有商业IT的兼容
## 新的社会经济秩序
### 自然人的数据重构
平行链，集信
### 机器与物权的重构
EVM上二进制代码的权利和移除权
### UBI universal basic income
当生产力由机器自主完成后，人的生产关系受到冲击，按照生产关系的酬劳体系被打破。  
资源大国的高福利国家就是基于能源价值与人类生产关系脱轨带来的结果  
UBI是更加彻底的协议，生产成果按人分配，带来更大的福利自由度，芬兰已经[开始尝试](https://www.theguardian.com/inequality/2018/jan/12/money-for-nothing-is-finlands-universal-basic-income-trial-too-good-to-be-true)，2020年的美国大选也有持该理念的参选者[Yang](https://www.yang2020.com)
